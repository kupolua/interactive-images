<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Interactive Presentation</title>

        <!-- Bootstrap framework -->
            <link rel="stylesheet" href="lib/gebo_admin/bootstrap/css/bootstrap.min.css" />

        <!-- wizard -->
            <link rel="stylesheet" href="lib/gebo_admin/lib/stepy/css/jquery.stepy.css" />

		<!-- uniform -->
		<link rel="stylesheet" href="lib/gebo_admin/lib/uniform/Aristo/uniform.aristo.css" />

		<!-- multiselect -->
		<link rel="stylesheet" href="lib/gebo_admin/lib/multi-select/css/multi-select.css" />

		<link rel="stylesheet" href="lib/gebo_admin/css/style.css" />

		<link rel="stylesheet" href="css/interactive-images.css">

			<link rel="stylesheet" href="lib/cropperjs/dist/cropper.css">
			<style>
				.container {
					max-width: 1200px;
					margin: 20px auto;
				}
				img {
					width: 100%;
				}
				.image {
					width: 20%;
				}
				.image-state {
					width: 30%;
				}
				.row,
				.preview {
					overflow: hidden;
				}
				.col {
					float: left;
				}
				.col-6 {
					width: 50%;
				}
				.col-3 {
					width: 25%;
					padding-left: 20px;
				}
				.col-2 {
					width: 16.7%;
				}
				.col-1 {
					width: 8.3%;
				}
				#next-button {
					padding: 2px 10px;
					background-color: white;
					color: black;
					border: 1px solid #393939; /* Green */
					border-radius: 4px;
					cursor:pointer
				}
				#reset-button {
					padding: 2px 10px;
					background-color: white;
					color: black;
					border: 1px solid #393939; /* Green */
					border-radius: 4px;
					cursor:pointer
				}
				#image-container {
					padding-bottom: 20px;
				}
			</style>


		<!-- favicon -->
            <link rel="shortcut icon" href="favicon.ico" />

        <!--[if lte IE 8]>
            <link rel="stylesheet" href="lib/gebo_admin/css/ie.css" />
        <![endif]-->

        <!--[if lt IE 9]>
			<script src="lib/gebo_admin/js/ie/html5.js"></script>
			<script src="lib/gebo_admin/js/ie/respond.min.js"></script>
			<script src="lib/gebo_admin/lib/flot/excanvas.min.js"></script>
        <![endif]-->
	</head>
	<body class="full_width">
		<div id="contentwrapper">
			<div class="main_content">
				<div class="col-sm-12 col-md-12">
				<h3 class="heading">Interactive Presentation - Teacher page</h3>
					<div class="col-sm-12 col-md-12">
						<form id="simple_wizard" class="stepy-wizzard form-horizontal">
							<fieldset id="images-selection" title="Images selection">

								<div data-provides="fileupload" class="fileupload fileupload-new image-container">
									<div class="row">
										<div class="col-sm-6 col-md-6">
											<label><b>Input image name</b></label>
											<input class="form-control image-name" type="text">
										</div>
									</div>
									<div class="input-group">
										<div class="form-control">
											<i class="icon-file fileupload-exists"></i> <span class="fileupload-preview"></span>
										</div>
										<div class="input-group-btn">
											<a data-dismiss="fileupload" class="btn btn-default fileupload-exists" href="#">Remove</a>
											<span class="btn btn-default btn-file">
												<span class="fileupload-new">Select file</span>
												<span class="fileupload-exists">Change</span>
												<input type="file">
											</span>
										</div>
									</div>
									<img class="image" src="img/no-image-selected.jpeg" alt="Not selected">
								</div>

								<div data-provides="fileupload" class="fileupload fileupload-new image-container">
									<div class="row">
										<div class="col-sm-6 col-md-6">
											<label><b>Input image name</b></label>
											<input class="form-control image-name" type="text">
										</div>
									</div>
									<div class="input-group">
										<div class="form-control">
											<i class="icon-file fileupload-exists"></i> <span class="fileupload-preview"></span>
										</div>
										<div class="input-group-btn">
											<a data-dismiss="fileupload" class="btn btn-default fileupload-exists" href="#">Remove</a>
											<span class="btn btn-default btn-file">
												<span class="fileupload-new">Select file</span>
												<span class="fileupload-exists">Change</span>
												<input type="file">
											</span>
										</div>
									</div>
									<img class="image" src="img/no-image-selected.jpeg" alt="Not selected">
								</div>

								<div data-provides="urlupload" class="urlupload urlupload-new image-container">
									<div class="row">
										<div class="col-sm-6 col-md-6">
											<label><b>Input image name</b></label>
											<input class="form-control image-name" type="text">
										</div>
									</div>
									<div class="input-group">
											<input class="form-control image-url" type="url">
										<div class="input-group-btn">
											<a data-dismiss="urlupload" class="btn btn-default urlupload-exists" href="#">Remove</a>
											<span class="btn btn-default btn-url">
												<span class="urlupload-new get-image">Get image</span>
												<span class="urlupload-exists">Change</span>
											</span>
										</div>
									</div>
									<img class="image" src="img/no-image-selected.jpeg" alt="Not selected">
								</div>

								<div data-provides="urlupload" class="urlupload urlupload-new image-container">
									<div class="row">
										<div class="col-sm-6 col-md-6">
											<label><b>Input image name</b></label>
											<input class="form-control image-name" type="text">
										</div>
									</div>
									<div class="input-group">
											<input id="input-url" class="form-control image-url" type="url">
										<div class="input-group-btn">
											<a data-dismiss="urlupload" class="btn btn-default urlupload-exists" href="#">Remove</a>
											<span class="btn btn-default btn-url">
												<span class="urlupload-new get-image">Get image</span>
												<span class="urlupload-exists">Change</span>
											</span>
										</div>
									</div>
									<img class="image" src="img/no-image-selected.jpeg" alt="Not selected">
								</div>

								<legend class="hide">add images to course…</legend>
								<div class="container">
									<!--<h3>Customize image</h3>-->

									<!--<div class="row">-->
										<!--<div id="image-label" class="col col-6">-->
											<!--<label>Customize image</label>-->
										<!--</div>-->
										<!--<div id="image-preview-label" class="col col-3">-->
											<!--<label>Preview image</label>-->
										<!--</div>-->
									<!--</div>-->
									<!--<div class="row">-->
										<!--<div id="image-container" class="col col-6">-->
											<!--<img id="image" src="img/no-image-selected.jpeg" alt="Not selected">-->
										<!--</div>-->
										<!--<div class="col col-3">-->
											<!--<div class="preview"></div>-->
										<!--</div>-->
									<!--</div>-->
								</div>
							</fieldset>
							<fieldset id="predictions-configure" title="Predicates configure">
								<legend class="hide">compose course rules…</legend>
									<div class="row">
										<label><b>Input transition name</b></label>
									<div class="col-sm-9 col-md-9">
										<input class="form-control transition-name" type="text">
									</div>
								</div>
									<div class="row">
										<label><b>Choose an initial transition image</b></label>
										<div class="col-sm-6 col-md-6">
											<select name="chosen_a" id="chosen_a" data-placeholder="Choose a target image" class="chzn_a form-control images-list initial-transition-name">
												<option value=""></option>
											</select>
										</div>
								</div>
								<div class="row">
									<label><b>Proposition</b></label>
									<div class="col-sm-6 col-md-6">
										<p><span class="label label-default">type</span></p>
										<select name="chosen_a" id="chosen_b" data-placeholder="Choose a proposition type" class="chzn_a form-control proposition-type">
											<option value=""></option>
											<option value="FIXED_CHOICE">FIXED_CHOICE</option>
											<option value="ANY_STRING">ANY_STRING</option>
											<option value="ANY_NUMBER">ANY NUMBER</option>
											<option value="ANY_INTEGER">ANY INTEGER</option>
											<option value="TRUE_FALSE">TRUE FALSE</option>
										</select>
									</div>
								</div>
								<div class="row">
									<div class="col-sm-6 col-md-6">
										<p><span class="label label-default">condition</span></p>
										<input class="form-control proposition-value" type="text">
										<input class="form-control proposition-value" type="text">
										<input class="form-control proposition-value" type="text">
									</div>
									<div class="col-sm-6 col-md-6">
										<p><span class="label label-default">choose a target image</span></p>
										<select name="chosen_a" id="chosen_c" data-placeholder="Choose a target image" class="chzn_a form-control images-list proposition-image">
											<option value=""></option>
										</select>
										<select name="chosen_a" id="chosen_d" data-placeholder="Choose a target image" class="chzn_a form-control images-list proposition-image">
											<option value=""></option>
										</select>
										<select name="chosen_a" id="chosen_f" data-placeholder="Choose a target image" class="chzn_a form-control images-list proposition-image">
											<option value=""></option>
										</select>

									</div>
								</div>
							</fieldset>
							<fieldset id="course-preview" title="Course preview">
								<legend class="hide">view final state of course…</legend>
								<div id="interactive-images-component"></div>
							</fieldset>
							<button type="button" class="finish btn btn-primary"><i class="glyphicon glyphicon-ok"></i> Create course</button>
						</form>
					</div>
				</div>
			</div>
			</div>
		</div>

		<script src="lib/gebo_admin/js/jquery.min.js"></script>
		<script src="lib/gebo_admin/js/jquery-migrate.min.js"></script>
		<script src="lib/gebo_admin/lib/jquery-ui/jquery-ui-1.10.0.custom.min.js"></script>
		<script src="lib/gebo_admin/js/jquery_cookie_min.js"></script>
		<script src="lib/gebo_admin/bootstrap/js/bootstrap.min.js"></script>
		<script src="lib/gebo_admin/bootstrap/js/bootstrap.plugins.min.js"></script>
		<script src="lib/gebo_admin/bootstrap/js/bootstrap.plugins.js"></script>
		<script src="lib/gebo_admin/lib/typeahead/typeahead.min.js"></script>
		<script src="lib/gebo_admin/lib/google-code-prettify/prettify.min.js"></script>
		<script src="lib/gebo_admin/lib/jBreadcrumbs/js/jquery.jBreadCrumb.1.1.min.js"></script>
		<script src="lib/gebo_admin/js/jquery.actual.min.js"></script>
		<script src="lib/gebo_admin/lib/UItoTop/jquery.ui.totop.min.js"></script>
		<script src="lib/gebo_admin/js/selectNav.js"></script>
		<script src="lib/gebo_admin/lib/uniform/jquery.uniform.js"></script>
		<script src="lib/gebo_admin/lib/validation/jquery.validate.min.js"></script>
		<script src="lib/gebo_admin/lib/stepy/js/jquery.stepy.min.js"></script>
		<script src="lib/gebo_admin/js/forms/jquery.ui.touch-punch.min.js"></script>
		<script src="lib/gebo_admin/js/jquery.easing.1.3.min.js"></script>
		<script src="lib/gebo_admin/js/jquery.debouncedresize.min.js"></script>
		<script src="lib/gebo_admin/js/forms/jquery.inputmask.min.js"></script>
		<script src="lib/gebo_admin/js/forms/jquery.autosize.min.js"></script>
		<script src="lib/gebo_admin/js/forms/jquery.counter.min.js"></script>
		<script src="lib/gebo_admin/lib/timepicker/js/bootstrap-timepicker.min.js"></script>
		<script src="lib/gebo_admin/lib/tag_handler/jquery.taghandler.min.js"></script>
		<script src="lib/gebo_admin/lib/multi-select/js/jquery.quicksearch.js"></script>
		<script src="lib/gebo_admin/js/pages/gebo_wizard.js"></script>

		<script src="lib/cropperjs/dist/cropper.js"></script>

		<script src="lib/mustache.min.js"></script>
		<script src="js/Logger.js"></script>
		<script src="js/CoursePreviewer.js"></script>
		<script src="js/NetworkTransporter.js"></script>
		<script src="js/ModelBuilder.js"></script>
		<script src="js/ViewPublisher.js"></script>
		<script src="js/HTMLTemplatesLibrary.js"></script>
		<script src="js/ViewHandler.js"></script>
		<script src="js/ComponentListener.js"></script>

		<script>
			var cropper,
				currentStep,
				courseSteps = new Map();

			var TemplateModel = {
				initialImageId: '',
				images: [],
				transitions: []
			};

			courseSteps.set(2, buildImagesDropDownList);
			courseSteps.set(3, setTransitions);

			var logger = new Logger();

			function makeHash(length) {
				var text = "";
				var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

				for( var i=0; i < length; i++ )
					text += possible.charAt(Math.floor(Math.random() * possible.length));

				return text;
			}

			function each(arr, callback) {
				var length = arr.length;
				var i;
				for (i = 0; i < length; i++) {
					callback.call(arr, arr[i], i, arr);
				}
				return arr;
			}

			function getImages() {
				var imageContainer = $('.image-container'),
					images = [];

				for (var i = 0; i < imageContainer.length; i++) {
					var imageName = $(imageContainer[i]).find('.image-name').val();
					var imageData = $(imageContainer[i]).find('.image').attr('src');
					var isBase64 = imageData.match("base64") ? true : false;
					var imageSrc = imageData.replace(/^data:image\/(png|jpg);base64,/, "");
					var key = makeHash(32);

					images[i] = {
						title: imageName,
						key: key,
						value: {
							imageName: imageName,
							isBase64: isBase64,
							imageSrc: imageSrc
						}
					};
				}

				return images;
			}

			function getImageKey(predicate) {
				var imageKey;

				images.forEach(function (item) {
					if(item.value.imageName == predicate) {
						imageKey = item.key;
					}
				});

				return imageKey;
			}

			function buildImagesDropDownList(TemplateModel) {
				var images = getImages();

				$('.images-preview img').remove();

				images.forEach(function (item, i) {
					$('.images-list').each(function () {
						$(this).append("<option value=\"" + item.key + "\">" + item.value.imageName + "</option>");
					});
				});

				TemplateModel.images = images;
			}

			function setTransitions(TemplateModel) {
				var transitions = [ //todo: getImageKey($(this).val()) doesn't work correctly. It's return only first position
					{
						imageId: '',
						transitionName: '',
						proposition: {
							type: '', // other options like 'FIXED_CHOICE', 'ANY_STRING', 'ANY_NUMBER', 'ANY_INTEGER', 'TRUE_FALSE'
							values: []
						},
						conditions: []
					}
				];
				TemplateModel.initialImageId = $('.initial-transition-name option:selected').val();
				transitions[0].imageId = $('.initial-transition-name option:selected').val(); //todo: will we expect more then 1 transition? Why we used array?
				transitions[0].transitionName = $('.transition-name').val();
				transitions[0].proposition.type = $('.proposition-type').val();
				$('.proposition-value').each(function(index) {
					transitions[0].proposition.values[index] = $(this).val();
				});
				$('.proposition-image').each(function(index) {
					transitions[0].conditions[index] = {
						predicate: "function(value){return value==\'" + transitions[0].proposition.values[index] + "\';}",
						targetImageId: $(this).find(":selected").val()
					};
				});

				TemplateModel.transitions = transitions;

				CoursePreviewer(TemplateModel);

			}
			
			function buildCoursePreview(TemplateModel) {
				console.log(TemplateModel)
			}

			window.addEventListener('DOMContentLoaded', function () {
//				croppImage();

				$("li").on('DOMAttrModified', function(e) {
					if ( $(e.target).hasClass('current-step') ) {
						currentStep = Math.floor($(".current-step").children(".stepNb").text());

						courseSteps.get(currentStep)(TemplateModel);
					}
				});

				$('input[type=file]').change(function () {
					var preview = this;
					var file    = this.files[0];

					var reader  = new FileReader();
					reader.addEventListener("load", function () {
						$(preview).parents().map(function() {
							$(this).children('.image').attr('src', reader.result);
						});

//						cropper.destroy();

//						$('.preview img').remove();

//						preview.src = reader.result;

//						croppImage();
					}, false);

					if (file) {
						reader.readAsDataURL(file);
					}
				});
				$('.image-container .get-image').click(function () {
					var preview = this,
						url;

					$(preview).parents().map(function() {
						if ($(this).children('.image-url').val()) {
							url = $(this).children('.image-url').val();
						}
						var img = $(this).children('.image');
						$(img[0]).attr('src', url);
					});
				});
			});
			function getBase64Image(img) {
				var canvas = document.createElement("canvas");
				canvas.width = img.width;
				canvas.height = img.height;
				var ctx = canvas.getContext("2d");
				ctx.drawImage(img, 0, 0);

				var dataURL = canvas.toDataURL("image/png");

				return dataURL;
//				return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
			}
			function croppImage() {
				var image = document.getElementById('image');
				var previews = document.querySelectorAll('.preview');
				cropper = new Cropper(image, {
					dragMode: 'move',
					ready: function () {
						var clone = this.cloneNode();
						clone.className = ''
						clone.style.cssText = (
								'display: block;' +
								'width: 100%;' +
								'min-width: 0;' +
								'min-height: 0;' +
								'max-width: none;' +
								'max-height: none;'
						);
						each(previews, function (elem) {
							elem.appendChild(clone.cloneNode());
						});
					},
					crop: function (e) {
						var data = e.detail;
						var cropper = this.cropper;
						var imageData = cropper.getImageData();
						var previewAspectRatio = data.width / data.height;
						each(previews, function (elem) {
							var previewImage = elem.getElementsByTagName('img').item(0);
							var previewWidth = elem.offsetWidth;
							var previewHeight = previewWidth / previewAspectRatio;
							var imageScaledRatio = data.width / previewWidth;
							elem.style.height = previewHeight + 'px';
							previewImage.style.width = imageData.naturalWidth / imageScaledRatio + 'px';
							previewImage.style.height = imageData.naturalHeight / imageScaledRatio + 'px';
							previewImage.style.marginLeft = -data.x / imageScaledRatio + 'px';
							previewImage.style.marginTop = -data.y / imageScaledRatio + 'px';
						});
					}
				});
			}
			
		</script>

    </body>
</html>
