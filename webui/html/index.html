<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Interactive Presentation</title>

        <!-- Bootstrap framework -->
            <link rel="stylesheet" href="lib/gebo_admin/bootstrap/css/bootstrap.min.css" />

        <!-- wizard -->
            <link rel="stylesheet" href="lib/gebo_admin/lib/stepy/css/jquery.stepy.css" />

		<!-- uniform -->
		<link rel="stylesheet" href="lib/gebo_admin/lib/uniform/Aristo/uniform.aristo.css" />

		<!-- multiselect -->
		<link rel="stylesheet" href="lib/gebo_admin/lib/multi-select/css/multi-select.css" />

		<link rel="stylesheet" href="lib/gebo_admin/css/style.css" />

		<link rel="stylesheet" href="css/interactive-images.css">

		<link rel="stylesheet" href="lib/cropperjs/dist/cropper.css">

		<link rel="stylesheet" href="lib/thumbnail-scroller-master/jquery.mThumbnailScroller.css">

			<style>
				.content{
					overflow: auto;
					position: relative;
					padding: 10px;
					background-color: #f9f9f9;
					margin: 20px;
					width: 40%;
					height: auto;
					float: left;
				}
				.content li{
					margin: 4px;
					overflow: hidden;
				}
				.content li a{
					display: inline-block;
					border: 7px solid rgba(255,255,255,.1);
				}
				#content-3 .mTSButton{
					background-color: #333;
				}
				.container {
					max-width: 1200px;
					margin: 20px auto;
				}
				img {
					width: 100%;
				}
				.image {
					width: 20%;
				}
				.preview-image {
					width: 50%;
				}
				.image-thumb {
					border-left: 5px;
					width: 250px;
				}
				.image-state {
					width: 30%;
				}
				.row,
				.preview {
					overflow: hidden;
				}
				.col {
					float: left;
				}
				.col-6 {
					width: 50%;
				}
				.col-3 {
					width: 25%;
					padding-left: 20px;
				}
				.col-2 {
					width: 16.7%;
				}
				.col-1 {
					width: 8.3%;
				}
				#next-button {
					padding: 2px 10px;
					background-color: white;
					color: black;
					border: 1px solid #393939; /* Green */
					border-radius: 4px;
					cursor:pointer
				}
				#reset-button {
					padding: 2px 10px;
					background-color: white;
					color: black;
					border: 1px solid #393939; /* Green */
					border-radius: 4px;
					cursor:pointer
				}
				#image-container {
					padding-bottom: 20px;
				}
			</style>


		<!-- favicon -->
            <link rel="shortcut icon" href="favicon.ico" />

        <!--[if lte IE 8]>
            <link rel="stylesheet" href="lib/gebo_admin/css/ie.css" />
        <![endif]-->

        <!--[if lt IE 9]>
			<script src="lib/gebo_admin/js/ie/html5.js"></script>
			<script src="lib/gebo_admin/js/ie/respond.min.js"></script>
			<script src="lib/gebo_admin/lib/flot/excanvas.min.js"></script>
        <![endif]-->
	</head>
	<body class="full_width">

	<!--<div id="demo">-->
		<!--<section id="examples">-->
			<!-- demo content -->
			<!--<div id="content-3" class="content">-->
				<!--<ul id="images-tape-container"></ul>-->
			<!--</div>-->
			<!-- -//- -->
		<!--</section>-->
	<!--</div>-->
		<div id="contentwrapper">
			<div class="main_content">
				<div class="col-sm-12 col-md-12">
				<h3 class="heading">Interactive Presentation - Teacher page</h3>
					<img class="col-sm-12 col-md-12">
						<form id="simple_wizard" class="stepy-wizzard form-horizontal">
							<fieldset id="images-selection" title="Images selection">
								<div data-provides="fileupload" class="fileupload fileupload-new image-container-btn">
									<div class="row">
										<div class="col-sm-6 col-md-6">
											<label><b>Input image name</b></label>
											<input class="form-control image-path" type="text">
										</div>
									</div>
									<label><b>Upload image</b></label>
									<div class="input-group col-sm-3 col-md-3">
										<div class="form-control">
											<i class="icon-file fileupload-exists"></i> <span class="fileupload-preview"></span>
										</div>
										<div class="input-group-btn">
											<a data-dismiss="fileupload" class="btn btn-default fileupload-exists" href="#">Remove</a>
											<span class="btn btn-default btn-file">
												<span class="fileupload-new">Select file</span>
												<span class="fileupload-exists">Change</span>
												<input type="file">
											</span>
										</div>
									</div>
								</div>

								<div data-provides="urlupload" class="urlupload urlupload-new image-container-btn">
									<label><b>or set image url</b></label>
									<div class="input-group col-sm-3 col-md-3">
											<input id="input-url" class="form-control image-url" type="url">
										<div class="input-group-btn">
											<a data-dismiss="urlupload" class="btn btn-default urlupload-exists" href="#">Remove</a>
											<span class="btn btn-default btn-url">
												<span class="urlupload-new get-image">Get image</span>
												<span class="urlupload-exists">Change</span>
											</span>
										</div>
									</div>
								</div>

								<div class="row">
									<div class="preview-image-container"></div>
								</div>

								<button type="button" class="add-image btn btn-primary"><i class="glyphicon glyphicon-ok"></i> Add image</button>
								<button type="button" class="clear-form btn btn-warning"><i class="glyphicon glyphicon-trash"></i> Clear form</button>

								<div class="row">
									<div class="images-container"><ul></ul></div>
								</div>

								<legend class="hide">add images to course…</legend>
							</fieldset>
							<fieldset id="predictions-configure" title="Predicates configure">
								<legend class="hide">compose course rules…</legend>
									<div class="row">
										<label><b>Input transition name</b></label>
									<div class="col-sm-9 col-md-9">
										<input class="form-control transition-name" type="text">
									</div>
								</div>
									<div class="row">
										<label><b>Choose initial image</b></label>
										<!--<div class="col-sm-12 col-md-12">-->
											<!--<div id="images-tape" class="col-sm-12 col-md-12"></div>-->
										<div id="content-3" class="content">
											<ul id="images-tape-container"></ul>
										</div>

											<!--<select name="chosen_a" id="chosen_a" data-placeholder="Choose a target image" class="chzn_a form-control images-list initial-transition-name">-->
												<!--<option value=""></option>-->
											<!--</select>-->
										<!--</div>-->
								</div>
								<div class="row">
									<label><b>Proposition</b></label>
									<div class="col-sm-6 col-md-6">
										<p><span class="label label-default">type</span></p>
										<select name="chosen_a" id="chosen_b" data-placeholder="Choose a proposition type" class="chzn_a form-control proposition-type">
											<option value=""></option>
											<option value="FIXED_CHOICE">FIXED_CHOICE</option>
											<option value="ANY_STRING">ANY_STRING</option>
											<option value="ANY_NUMBER">ANY NUMBER</option>
											<option value="ANY_INTEGER">ANY INTEGER</option>
											<option value="TRUE_FALSE">TRUE FALSE</option>
										</select>
									</div>
								</div>
								<div class="row">
									<div class="col-sm-6 col-md-6">
										<p><span class="label label-default">condition</span></p>
										<input class="form-control proposition-value" type="text">
										<input class="form-control proposition-value" type="text">
										<input class="form-control proposition-value" type="text">
									</div>
									<div class="col-sm-6 col-md-6">
										<p><span class="label label-default">choose a target image</span></p>
										<select name="chosen_a" id="chosen_c" data-placeholder="Choose a target image" class="chzn_a form-control images-list proposition-image">
											<option value=""></option>
										</select>
										<select name="chosen_a" id="chosen_d" data-placeholder="Choose a target image" class="chzn_a form-control images-list proposition-image">
											<option value=""></option>
										</select>
										<select name="chosen_a" id="chosen_f" data-placeholder="Choose a target image" class="chzn_a form-control images-list proposition-image">
											<option value=""></option>
										</select>

									</div>
								</div>
							</fieldset>
							<fieldset id="course-preview" title="Course preview">
								<legend class="hide">view final state of course…</legend>
								<div id="interactive-images-component"></div>
							</fieldset>
							<button type="button" class="finish btn btn-primary"><i class="glyphicon glyphicon-ok"></i> Create course</button>
						</form>
						<div id="checkThumb"></div>
					</div>
				</div>
			</div>
			</div>
		</div>

		<script src="lib/gebo_admin/js/jquery.min.js"></script>
		<script src="lib/gebo_admin/js/jquery-migrate.min.js"></script>
		<script src="lib/gebo_admin/lib/jquery-ui/jquery-ui-1.10.0.custom.min.js"></script>
		<script src="lib/gebo_admin/js/jquery_cookie_min.js"></script>
		<script src="lib/gebo_admin/bootstrap/js/bootstrap.min.js"></script>
		<script src="lib/gebo_admin/bootstrap/js/bootstrap.plugins.min.js"></script>
		<script src="lib/gebo_admin/bootstrap/js/bootstrap.plugins.js"></script>
		<script src="lib/gebo_admin/lib/typeahead/typeahead.min.js"></script>
		<script src="lib/gebo_admin/lib/google-code-prettify/prettify.min.js"></script>
		<script src="lib/gebo_admin/lib/jBreadcrumbs/js/jquery.jBreadCrumb.1.1.min.js"></script>
		<script src="lib/gebo_admin/js/jquery.actual.min.js"></script>
		<script src="lib/gebo_admin/lib/UItoTop/jquery.ui.totop.min.js"></script>
		<script src="lib/gebo_admin/js/selectNav.js"></script>
		<script src="lib/gebo_admin/lib/uniform/jquery.uniform.js"></script>
		<script src="lib/gebo_admin/lib/validation/jquery.validate.min.js"></script>
		<script src="lib/gebo_admin/lib/stepy/js/jquery.stepy.min.js"></script>
		<script src="lib/gebo_admin/js/forms/jquery.ui.touch-punch.min.js"></script>
		<script src="lib/gebo_admin/js/jquery.easing.1.3.min.js"></script>
		<script src="lib/gebo_admin/js/jquery.debouncedresize.min.js"></script>
		<script src="lib/gebo_admin/js/forms/jquery.inputmask.min.js"></script>
		<script src="lib/gebo_admin/js/forms/jquery.autosize.min.js"></script>
		<script src="lib/gebo_admin/js/forms/jquery.counter.min.js"></script>
		<script src="lib/gebo_admin/lib/timepicker/js/bootstrap-timepicker.min.js"></script>
		<script src="lib/gebo_admin/lib/tag_handler/jquery.taghandler.min.js"></script>
		<script src="lib/gebo_admin/lib/multi-select/js/jquery.quicksearch.js"></script>
		<script src="lib/gebo_admin/js/pages/gebo_wizard.js"></script>

		<script src="lib/thumbnail-scroller-master/jquery.mThumbnailScroller.js"></script>

		<script src="lib/cropperjs/dist/cropper.js"></script>

		<script src="lib/mustache.min.js"></script>
		<script src="js/Logger.js"></script>
		<script src="js/CoursePreviewer.js"></script>
		<script src="js/NetworkTransporter.js"></script>
		<script src="js/ModelBuilder.js"></script>
		<script src="js/ViewPublisher.js"></script>
		<script src="js/HTMLTemplatesLibrary.js"></script>
		<script src="js/ViewHandler.js"></script>
		<script src="js/ComponentListener.js"></script>

		<script>
			var cropper,
				currentStep,
				courseSteps = new Map();

			var TemplateModel = {
				initialImageId: '',
				images: [],
				transitions: []
			};

			courseSteps.set(2, buildImagesDropDownList);
			courseSteps.set(3, setTransitions);

			var logger = new Logger();

			function makeHash(length) {
				var text = "";
				var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

				for( var i=0; i < length; i++ )
					text += possible.charAt(Math.floor(Math.random() * possible.length));

				return text;
			}

			function each(arr, callback) {
				var length = arr.length;
				var i;
				for (i = 0; i < length; i++) {
					callback.call(arr, arr[i], i, arr);
				}
				return arr;
			}

			function getImages() {
				var imageContainer = $('.image-container'),
					images = [];

				for (var i = 0; i < imageContainer.length; i++) {
					var imageName = $(imageContainer[i]).find('.image-name').text();
					var imageData = $(imageContainer[i]).find('.image').attr('src');
					var isBase64 = imageData.match("base64") ? true : false;
					var imageSrc = imageData.replace(/^data:image\/(png|jpg);base64,/, "");
					var key = makeHash(32);

					images[i] = {
						title: imageName,
						key: key,
						value: {
							imageName: imageName,
							isBase64: isBase64,
							imageSrc: imageSrc
						}
					};
				}

				return images;
			}

			function getImageKey(predicate) {
				var imageKey;

				images.forEach(function (item) {
					if(item.value.imageName == predicate) {
						imageKey = item.key;
					}
				});

				return imageKey;
			}

			function buildImagesDropDownList(TemplateModel) {
				var images = getImages();

				$('.images-preview img').remove();

				images.forEach(function (item, i) {
					$('#images-tape-container').append("<li><img id='" + item.value.imageName + "' class='image-thumb' src=\"" + (item.value.isBase64 ? ("data:image\/(png|jpg);base64," + item.value.imageSrc) : item.value.imageSrc) + "\" onclick='thumbHandler(this);'></li>");
				});

				$("#content-3").mThumbnailScroller({
					type:"click-50",
					theme:"buttons-in"
				});

				TemplateModel.images = images;
			}

			function setTransitions(TemplateModel) {
				var transitions = [ //todo: getImageKey($(this).val()) doesn't work correctly. It's return only first position
					{
						imageId: '',
						transitionName: '',
						proposition: {
							type: '', // other options like 'FIXED_CHOICE', 'ANY_STRING', 'ANY_NUMBER', 'ANY_INTEGER', 'TRUE_FALSE'
							values: []
						},
						conditions: []
					}
				];
				TemplateModel.initialImageId = $('.initial-transition-name option:selected').val();
				transitions[0].imageId = $('.initial-transition-name option:selected').val(); //todo: will we expect more then 1 transition? Why we used array?
				transitions[0].transitionName = $('.transition-name').val();
				transitions[0].proposition.type = $('.proposition-type').val();
				$('.proposition-value').each(function(index) {
					transitions[0].proposition.values[index] = $(this).val();
				});
				$('.proposition-image').each(function(index) {
					transitions[0].conditions[index] = {
						predicate: "function(value){return value==\'" + transitions[0].proposition.values[index] + "\';}",
						targetImageId: $(this).find(":selected").val()
					};
				});

				TemplateModel.transitions = transitions;

				CoursePreviewer(TemplateModel);

			}
			
			function buildCoursePreview(TemplateModel) {
				console.log(TemplateModel)
			}
			
			function thumbHandler(thumb) {
				$(thumb).css('border', '3px solid #1A693D');
			}

			window.addEventListener('DOMContentLoaded', function () {
				clearInputFields();

				var imageText,
					file,
					isRemoved = false;

				$("li").on('DOMAttrModified', function(e) {
					if ( $(e.target).hasClass('current-step') ) {
						currentStep = Math.floor($(".current-step").children(".stepNb").text());

						courseSteps.get(currentStep)(TemplateModel);
					}
				});

				$('.fileupload-exists').click(function () {
					$(".preview-container").remove();
					file = '';
					imageText = '';
					isRemoved = true;
				});

				$('input[type=file]').change(function (event) {
					var preview = this;
					file    = this.files[0];
					imageText = $(".image-path").val();
					if(!isRemoved) {
						$(".preview-image-container").html("<div class='preview-container'><label class='image-name'>" + imageText + "</label><img class='preview-image'></div>");
						var img = $(".preview-image");

						var reader = new FileReader();
						reader.addEventListener("load", function () {
							$(preview).parents().map(function () {
								if (reader.result) {
									$(img).attr('src', reader.result);
									isRemoved = false;
								}
							});
						}, false);

						if (file) {
							reader.readAsDataURL(file);
						}
					}
					if (isRemoved) {
						isRemoved = false;
						return;
					}
				});
				$('.image-container-btn .get-image').click(function () {
					var preview = this,
						url,
						imageText = $(".image-path").val();

					$(preview).parents().map(function() {
						if ($(this).children('.image-url').val()) {
							$(".preview-image-container").html("<div><label class='image-name'>" + imageText + "</label><img class='preview-image'></div>");
							var img = $(".preview-image");

							url = $(this).children('.image-url').val();
							$(img).attr('src', url);
						}
					});
				});
				$('.add-image').click(function () {
					$(".preview-image-container").clone().prependTo(".images-container");

					$('.images-container').find('.preview-image-container').addClass('image-container').removeClass('preview-image-container');
					$('.images-container').find('.preview-container').removeClass('preview-container');
					$('.images-container').find('.preview-image').addClass('image').removeClass('preview-image');

					$(".preview-image-container").html("");

					clearInputFields();
				});
				$('.clear-form').click(function () {
					clearInputImagesForm();
				});
			});
			function getBase64Image(img) {
				var canvas = document.createElement("canvas");
				canvas.width = img.width;
				canvas.height = img.height;
				var ctx = canvas.getContext("2d");
				ctx.drawImage(img, 0, 0);

				var dataURL = canvas.toDataURL("image/png");

				return dataURL;
//				return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
			}
			
			function clearInputFields() {
				$('a.fileupload-exists').click();
				$('.image-title').val('');
				$('.image-path').val('');
				$('.image-url').val('');
			}
			function clearInputImagesForm() {
				clearInputFields();
				$(".images-container").html('');
				TemplateModel = {
					initialImageId: '',
					images: [],
					transitions: []
				}
			}
		</script>

    </body>
</html>
